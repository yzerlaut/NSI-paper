Identifying Network States from Extracellular Recordings during Wakefulness in Neocortex
Short Title: Identifying Waking States from Extracellular Recordings
Authors: .. %Y. Zerlaut, S. Zucca, T. Fellin \& S. Panzeri
Short Authors: ... %Zerlaut, Zucca, Fellin \& Panzeri
Affiliations: 1. Neural Coding Laboratory @ Istituto Italiano di Tecnologia

* Abstract

The processing of sensory input in awake animals lies on top of substantial modulations in the collective dynamics of cortical networks. Understanding cortical function during wakefulness would therefore largely benefit from a measure of network states from commonly monitored electrophysiological signals. We provide here a Network State Index (NSI) giving a quantitative formulation to the “U-model" of arousal in sensory cortices from a population signal: the extracellular potential. We use simultaneous extracellular and intracellular recordings to design and calibrate a method gradually classifying network states from low frequency (2-10Hz) activity to asynchronous activity at various activation levels. We use this measure to analyze the link between single-cell (intracellular) and population (extracellular) signals over the different network regimes of wakefulness. We find that the graded levels of population signal during non-rhythmic activity is faithfully translated into the single cell depolarization levels. On the other hand, the graded levels of rhythmic population signals translate in a rather stereotypical oscillatory pattern of membrane potential. Finally, we show that the variability of network states, beyond the occurrence of slow synchronous activity, critically contribute to the average correlations between single cell and population signals during wakefulness.

* Introduction

During wakefulness, epochs corresponding to various levels of physiological and behavioral markers, such as pupil size and locomotion, have been correlated with various membrane potential signatures in rodent sensory cortices (Polack et al., 2013; McGinley et al., 2015a; Reimer et al., 2014). Those observations led to the notion of various network states during wakefulness in neocortex (McGinley et al., 2015b; Busse et al., 2017). An emergent picture for the modulation of network activity in sensory cortices is the "U-model" of arousal (McGinley et al., 2015b): a continuum of network states including three well-identified patterns of membrane potential fluctuations. At low arousal levels (quantified by a low pupil diameter and the absence of motor behavior), the membrane potential fluctuations exhibit a stereotypical [2,10]Hz oscillatory pattern (Poulet and Petersen, 2008;McGinley et al., 2015a;Reimer et al., 2014). At moderate arousal (quantified by an intermediate pupil diameter), single cells are hyperpolarized with low ongoing fluctuations (McGinley et al. 2015a, Reimer et al. 2014). At high arousal levels (under locomotion or and/or high pupil dilatation), the membrane potential exhibits a sustained depolarization with high-frequency $V_m$ fluctuations. 

What is the correlate of such network states in terms of extracellular potential in neocortex? And how does the graded aspect of this diversity of states (measured in terms of $V_m$ fluctuations) translate into extracellular signal ? By combining intra- and extracellular recordings in awake mice somato-sensory cortex, we address those questions in the present study.

We first show that the extracellular potential can be transformed into a signal exhibiting a high correlation with the membrane potential of pyramidal neurons. From this signal, we can perform the classification of the low frequency and asynchronous periods with their granularity. We then estimate the accuracy of this classification by comparing them with the $V_m$-defined network states. Finally, we analyze the impact of the spectrum of network states displayed within a single recording (as captured by our measure) on the correlation between our two simultaneously recorded neurophysiological signals. We find that the variability of network states (beyond the fraction of occurrence of slow rhythmic activity) is a key factor in shaping the correlation between those signals. This finding suggest that the variability of network states during wakefulness in a given experimental setting is a major contributor to the measured correlation between different neurophysiological signals.

* Materials and Methods

*** Animals 
Experimental procedures involving animals have been approved by the IIT Animal Welfare Body and by the Italian Ministry of Health (authorization \# 34/2015-PR and 125/2012-B), in accordance with the National legislation (D.Lgs. 26/2014) and the European legislation (European Directive 2010/63/EU). Experiments were performed on young-adult (4-6 weeks old, either sex) C57BL/6J mice (Charles River, Calco, Italy). The animals were housed in a 12:12 hr light-dark cycle in singularly ventilated cages, with access to food and water ad libitum.

*** Simultaneous extra- and intracellular recordings in awake mice

The experimental procedure for in vivo electrophysiological recordings in awake head-fixed mice have been previously described (Zucca et al., 2017). Briefly, custom metal plate where fixed on young (P22-P24) mice skull two weeks before the experimental sessions. After a 2-3 days recovery period, mice were habituated to sit quietly on the experimental setup for at least 7-10 days (one session per day and gradually increasing session duration). The day of the experiment, mice were anesthetized with 2.5\% isofluorane and a small craniotomy (0.5x0.5 mm) was opened over the somatosensory cortex and a 30 minutes long recovery period was provided to the animal before starting the recordings. Brain surface was kept moist with a HEPES-buffered artificial cerebrospinal fluid (ACSF). Extracellular recordings were performed by lowering a glass pipette filled with aCSF into the tissue with the deeper tip placed at $\sim$300 mm from pial surface. Simultaneous current-clamp patch-clamp recordings were carried out on superficial pyramidal neurons (100– 350 mm). 3–6 M$\Omega$ borosilicate glass pipettes (Hilgenberg, Malsfeld, Germany) were filled with an internal solution containing (in mM): K-gluconate 140, MgCl2 1, NaCl 8, Na2ATP 2, Na3GTP 0.5, HEPES 10, Tris-phosphocreatine 10 to pH 7.2 with KOH. Electrical signals were acquired using a Multiclamp 700B amplifier, filtered at 10 kHz, digitized at 50 kHz with a Digidata 1440 and stored with pClamp 10 (RRID:SCR\_011323, Axon Instruments, Union City, CA). 

*** Wavelet Transform

Our signal processing pipeline of the extracellular potential was based on the wavelet transform. We implemented a wavelet transform based on the Morlet wavelet, i.e. on the waveform:

\begin{equation}
M_{w_0}(f, t) = C_{w_0}(f) \cdot e^{2 i \pi f t} \cdot e^{-\big(\frac{\sqrt{2} \pi f t}{w_0}\big)^2}
\label{eq:Morlet}
\end{equation}
where $f$ is the frequency of the wavelet and $w_0$ the decay parameter of the envellope. Following "standards in wavelet analysis", we kept a value of $w_0$=6 all along the study. The coefficient $C_{f, w_0}$ is the normalization coefficient of the wavelet. Note that, to keep a meaningful link with the physical units of the signal, we did not normalize the wavelet with respect to itself, but with respect to a sinusoid (otherwise the wavelet transform with standard normalization of a sinusoid of frequency $f$ and amplitude 1 has a value greater than 1 at the frequency $f$). The wavelet normalization coefficient is defined, for a wavelet frequency $f$ and an extent $w_0$, by:

\begin{equation}
C_{w_0}(f) = \int_{-\infty}^{\infty} \cos (2 \pi f s) \cdot \overline{M_{w_0}(f, s)} \cdot ds = 
\frac{w_0}{2 \sqrt{2 \pi } f} \Big( 1 + e^{\frac{(w_0)^2}{2}} \Big)
\end{equation}


The transform was implemented by a convolution between the signal $S(t)$ and the complex conjuguate of the Morlet wavelet (Equation \ref{eq:Morlet}):

\begin{equation}
W(f, t) = \int_{-L}^L S(t) \cdot \overline{M_{w_0}(f, t-s)} ds
\label{eq:Morlet}
\end{equation}

From which the power and the phase at time $t$ of a given frequency $f$ in the signal can be extracted by taking the norm and argument of the complex number $W(f, t)$.

*** Computing the pLFP signal

We consider a frequency band spanning [$f_0/w_0$, $f_0 \cdot w_0$], where $f_0$ is a root frequency and $w_0$ the width parameter of the band. We take a set of $N$=20 wavelets uniformly spanning this band (i.e. evenly space from $f_0/w_0$ to $f_0 \cdot w_0$). The pLFP signal consists in the sum over $N$ of the $k$ wavelet powers of frequency $f_k \in [f_0/w_0, f_0 \cdot w_0]$  , i.e.:

\begin{equation}
pLFP(t) = \sum_{k \in [1,N]} \frac{\| W(f_k, t) \|}{N}
\label{eq:pLFP}
\end{equation}

*** Computing the Network State Index (NSI)

[...]

\begin{table}[tb!]
\small
\centering
\begin{tabular}{c|c|c|c}
~ & \multicolumn{1}{c|}{ \bf Parameter} & {\hfill \bf Symbol \hfill} & \multicolumn{1}{c}{ \bf Value} \\[.1em]
\hline \vspace{.1em}
\multirow{4}{*}{\rotatebox[origin=c]{90}{\parbox[c]{1cm}{\centering \bf fixed }}}
                     & pLFP root freq.     & $f_0$     & {f0} Hz \\[.5em]
& pLFP band factor & $w_0$ & {w0} \\[.5em]
& \multirow{2}{*}{\parbox[c]{3.2cm}{\centering factor for rhythmicity threshold}} 
                      & \multirow{2}{*}{$\alpha$ } 
                      & \multirow{2}{*}{ {alpha_opt} } \\
&&& \\
\hline
\multirow{4}{*}{\rotatebox[origin=c]{90}{\parbox[c]{1cm}{\centering \bf data-driven }}} & text &&\\
& \multirow{2}{*}{\parbox[c]{3.5cm}{pLFP lower bound}} & \multirow{2}{*}{$p_0$} & \multirow{2}{*}{ {p0_over_cells}$\mu$V } \\
\end{tabular}

\caption{\label{table:params} \small \textbf{Parameters of the NSI characterization.}
We summarize here all analysis parameters. We separate the parameters into two classes: the fixed parameters that are constant across different recordings (although there value has been experimentally determined from the average data, see Figure {pLFP} and Figure {NSI}) and the data-driven parameters that are evaluated on single recordings. \normalfont}
\normalfont
\end{table}


*** Data Analysis and Statistics

Data were analyzed with SciPy (Oliphant, 2007). Experimental data were translated to the Python format using Neo (RRID:SCR\_000634). 

*** Software implementation

We implemented the described analysis into a publicly available software, available at \url{https://github.com/yzerlaut/Waking_State_Index}. The software contains the described algorithm, a graphical user interface and the support to a few electrophysiological data formats.

* Results

*** FIGURE: The time-varying high-gamma power of the extracellular potential maximizes the correlation with the membrane potential of pyramidal neurons in awake mice S1.
#+options : {'label':'pLFP', 'extent': 'doublecolumn'}
(a) Example simultaneous recording of the extracellular ($V_{ext}$, top) and membrane potential of a layer 2/3 pyramidal cell ($V_m$, bottom). In the middle, we show the time-varying high-gamma power (brown thin line) and its smoothed fluctuations (brown thick line, the pLFP signal). The $p_0$ value (brown dotted line) corresponds to the 100th percentile of the pLFP signal. (b) We look for the frequency band that maximizes the correlation with the simultaneously recorded membrane potential. This is achieved by varying independently a root frequency $f$ and a width factor $w$ yielding the frequency band [$f$/$w$, $f \cdot w$]. For each frequency band, we divide the band into 20 evenly spaced wavelet frequencies, we compute the mean over frequencies of the wavelet power (resulting in the time-varying power shown in \textbf{a}) and report the cross-correlation with the $V_m$ trace (cc $V_m$-pLFP). The optimal band is found for $f_{opt}$={f0}Hz and $w_{opt}$={w0}  (c) . Testing the effect of temporal smoothing on the cross-correlation with the $V_m$ signal. Shown for all cells (individual cells are color-coded). At $T_{smoothing}$=0ms, one can see the mean value of \textbf{a} and its variability over cells (black errorbar).  (d) After normalization by their maximum amplitude (from their level at $T_{smoothing}$=0ms), a clear peak at $T_{opt}$={Tsmooth}ms appears.
[[./Figures/Fig_pLFP_design.png]]

*** The time-varying high-gamma power of the extracellular potential exhibits a high correlation with the membrane potential of pyramidal neurons in awake mice S1. 

So far, the different waking states in rodent sensory cortices have been defined from their membrane potential signature ([[McGinley et al., 2015b]]). We therefore looked for a quantitative link between the extracellular signal $V_{ext}$ and the membrane potential $V_m$ fluctuations to apply such classification.

Although the the extracellular potential fluctuations can display high correlation values with the membrane potential in awake animals (cc$\sim$0.6, [[Poulet and Petersen, 2008]]), the extracellular signal is also subjected to drifts over long recordings at both slow (>1min) and fast (<10s) time scales (e.g. see the drift at the $\sim$5s time scale between episodes (i) and (ii) in Figure {pLFP}a). Its absolute value therefore does not seem to provide a reliable quantity on which one can rely to perform a robust classification. 

Guided by findings under anesthesia ([[Mukovski et al., 2006]]), we hypothesized that the high-frequency content ($f$>40Hz) of the extracellular recording would provide a good predictor of the depolarization level. We therefore apply a wavelet transform to the extracellular signal and looked for the frequency band maximizing the cross-correlation with the membrane potential of a simultaneously recorded cell (see Figure {pLFP}b). We found that the optimal band was achieved for $f_{opt}$={f0}Hz and $w_{opt}$={w0}, i.e. the [{F_band_min},{F_band_max}]Hz band. A temporal smoothing was found to improve the similarity with the $V_m$ signal, the optimal value was found to be $T_{opt}$={Tsmooth}ms. We refer in the following to such smoothed high-gamma power as the "pLFP" (processed Local Field Potential, in analogy with the terminology of Mukovski et al. (2006)) and we interpret this quantity as the time-varying recruitment of local synaptic activity in the near ($\sim$300$\mu$m) cortical network surrounding the electrode (Buzsáki et al., 2012, Einevoll et al., 2013).

*** FIGURE: The Network State Index (NSI). We define a graded measure of network states based on the mean level (for non-rhythmic activity) or the low frequency power (for rhythmic activity) of the time-varying pLFP signal.
#+options : {'label':'NSI', 'extent': 'doublecolumn'}
(a) Example samples of activity at different NSI levels (bottom) with their corresponding $V_m$ (top) and pLFP (middle) fluctuations. In episodes (1,2) the pLFP and $V_m$ signals exhibit low frequency activity at different powers. In episodes (3-6) the pLFP and $V_m$ signals exhibit non-rhythmic activity at various levels (in terms of both pLFP and depolarization levels). Three time-varying quantities derived from the pLFP signal are used to classify network states: a weighted estimate of the low frequency contribution to the signal, the pLFP sliding mean and the low frequency power of the pLFP signal. A consistency criterion validates a fraction of those as identified network states (brown dots).  (b) Full recording with the simultaneous variations of $V_{ext}$ (top), $V_m$ (middle) and NSI (bottom). We indicate where the (numbered) samples shown in *a* have been extracted. (c) Fraction of rhythmic, non-rhythmic and Unclassified States as a function of the parameter $\alpha$ (weighting the propensity to classify as rhythmic states). (d) $V_m$ power of the [2,10]Hz band averaged across all identified non-rhythmic States for different values of the parameter $\alpha$. We fit the decay with an exponential function (dashed red line) and take its decay parameter as the optimal value for the classification. (e) $V_m$ power of the [2,10]Hz band in the samples (evaluated in 500ms time windows) averaged across all identified rhythmic State (purple bar) and non-rhythmic States (kaki bar) from the pLFP signal. (f) Mean depolarization level over all identified rhythmic states (purple color) and all non-rhythmic states (kaki color) at various phase of the [2,10]Hz fluctuations in the pLFP signal (see Methods).
[[./Figures/Fig_NSI_design.png]]

*** Designing a Network State Index (NSI)

After this transformation of the extracellular signal, we found a qualitative match between the previously evidenced $V_m$ signatures of network states and the signatures in terms of pLFP signal. We highlight this feature in Figure {NSI}a. One can see rhythmic activity at different power (episodes 1,2) as well as non-rhythmic fluctuations at various mean levels of pLFP signal (episodes 3-6), i.e. patterns of activity sampling the continuum of network states found in rodent sensory cortices during wakefulness (McGinley et al., 2015b).

We now aim at identifying the occurence of a given network state from the time-varying fluctuations of the pLFP signal. We describe in the following the signal processing step to achieve such a classification. 

We first compute the time-varying mean $Y(t)$ of the fluctuations over a long time scale ($T_{mean}$={T_sliding_mean}ms). We also compute the low frequency power of the fluctuations $Pow^{max}_{[2,10]Hz}$ (we take the maximum to account for the fact that rhythmicity can have varying frequencies in the [2,10]Hz band). From this last time-varying signal, we define a weighted estimate of the contribution of the slow rhythm to the full signal $X(t) = p_0 + \alpha Pow^{max}_{[2,10]Hz}$ (shown on Figure {pLFP}a together with $Y$). By comparing this estimate with the sliding mean, we classify as "rhythmic" or "non-rhythmic" by computing the sign of the difference: when Y(t)-X(t) is negative, activity is classified as rhythmic, when Y(t)-X(t) is positive, activity is classified as non-rhythmic. To keep the granularity of the different network states in our index, we now weight this binary quantity by the amplitude of the pLFP signal in the two regimes. For the rhythmic states the amplitude of the fluctuations is given by $2 \cdot Pow^{max}_{[2,10]Hz}$. For the non-rhythmic states, the amplitude of activity is given by its deviation from the baseline level, i.e. $(Y-p_0)$. Mathematically, this corresponds to a Network State Index (NSI) given by:

\begin{equation}
\label{eq:NSI}
\textrm{NSI}(t) = - 2 \cdot Pow^{max}_{[2,10]Hz} \cdot \mathcal{H}(X-Y) + (Y-p_0) \cdot \mathcal{H}(Y-X)
\end{equation}

where $\mathcal{H}$ is the Heaviside function (i.e. step function).

The variations of the NSI quantity over some sample episodes are shown in Figure {NSI}a. We highlight the decision process for rhythmic versus non-rhythmic activity based on the $X$ and $Y$ signals with a colored area on the pLFP axis (purple and kaki for rhythmic and non-rhythmic activity respectively) together with its negative or positive projection on the NSI axis (bottom plot).

As the time-varying signal $\textrm{NSI}(t)$ might exhibit arbitrary fluctuations, we complement this procedure with a consistency criteria to obtain a robust classification. We first define a network states window of $T_{state}$={Tstate}ms with a network state update every $T_{state}/2$={Tstate_update}ms. The consistency criteria requires that within a given time window of extent $T_{state}$, the fluctuations of the NSI signal remains within the noise level of the pLFP signal $p_{noise}$ (here taken as the $p_0$ value, see Methods). If this condition is not matched, a network state at a well-defined level can not be assessed in this time window. Consequently, the network state is labeled as "unclassified". The motivation behind this arbitrary time scale $T_{state}$ is that it offers a good compromise between two constraints: 1) being long enough to get well defined states (e.g. more than half a cycle for oscillations in the [2,10]Hz range) and 2) being short enough to catch the fast and frequent switches of network states during wakefulness (McGinley et al., 2015b). The "validated states" are highlighted with brown dots over some sample episodes in Figure {NSI}a (bottom) and over a full recording in Figure {NSI}b (bottom). Note in episodes 3-5 (Figure {NSI}a, bottom) how this consistency criterion impedes state validations around sign switches of the time-varying NSI signal (thin black line) or in the presence of strong variations in the NSI signal (at the start of episode 3).

Note that this classification relies on the difference between the average pLFP signal $Y(t)$ and the low-frequency contribution to the signal $X(t)$ (and not on the low frequency power only) because when the pLFP signal increase its [2,10]Hz power also increases (correlation coefficients between $Y$ and $X$ in the NSI>0 episodes {CCs_pLFP_lfPow_in_NR}, p={pvalue_CCs_pLFP_lfPow_in_NR}, paired t-test with the null hypothesis of a null correlation). This phenomena is visible on Figure {NSI}b, the power in episode 6 is equivalent the power in episode 2 without exhibiting the clear rhythmicity in the pLFP or in the $V_m$ signal that characterizes episode 2 (middle and top plots respectively).

*** Calibration of the rhythmicity condition

The parameter $\alpha$ weights the propensity to classify the network activity as rhythmic. This is visible on Figure {NSI}c, when one raises the $\alpha$ parameter, the proportion of gradually increase from $\sim$0\% at $\alpha<1$ to $\sim$100\% at $\alpha$>6. This parameter can therefore be adjusted with respect to the specific context in which the NSI is used (see Discussion). We nonetheless asked whether our dataset could give us an indication of the optimal value for this parameter. We used our simultaneous $V_m$ recording to find such a value. In Figure {NSI}d, we show the mean [2,10]Hz power of the membrane potential $V_m$ as a function of the $\alpha$ parameter (after averaging over all episodes classified as rhythmic for a given cell, computed for all cells). The low frequency $V_m$ power exhibits a clear exponential decay. A natural parameter that insures a consistency between the slow-rhythmicity in the $V_m$ and in the pLFP is therefore provided by the decay constant of this decrease. We fitted this parameter and found it to be $\alpha^{opt}$={alpha_opt}. 

Indeed, for this parameter, we find a strong decrease in $V_m$ power from rhythmic to non-rhythmic states after NSI classification for all cells (paired t-test, p={pvalue_decrease_in_slow_power_Vm_synch_to_asynch}, n={Ncells} cells, see Figure {NSI}e). Similarly, for such a value, the $V_m$ fluctuations of rhythmic episodes exhibit a clear rhythmic shape after averaging with respect to the phase of the pLFP signal (see Figure {NSI}f) while the pLFP phase has a much weaker impact in the non-rhythmic episodes. The rhythmic episodes displayed a mean hyperpolarization of {mean_depol_from_0_to_pi_synch}mV from the 0-phase to the $\pi$-phase of the pLFP signal while the non-rhythmic episodes displayed an hyperpolarization of {mean_depol_from_0_to_pi_asynch}mV (see Figure {NSI}f). Given the high variability of the depolarization at the single cycle level in both cases, {std_depol_from_0_to_pi_synch}mV for rhythmic episodes and {std_depol_from_0_to_pi_asynch}mV for non-rhythmic episodes (variability of the hyperpolarization level over all cycles), only the rhythmic activity exhibits a high reliability of single cycle depolarization (as quantified by the mean-to-variability ratios across cycles: {mean_to_var_depol_from_0_to_pi_synch} for rhythmic states compared to {mean_to_var_depol_from_0_to_pi_asynch} for non-rhythmic states, p={pval_mean_to_var_depol_from_0_to_pi}, n={Ncells} cells, paired t-test).

One could also hypothesize that the most accurate classification is the most conservative one, i.e. the one that maximizes the proportion of "unclassified" states. Interestingly, one can see on Figure {NSI}c that such value is achieved for $\alpha$={alpha_opt_of_max_unclassified} (thin grey dashed line), i.e. close to the $\alpha^{opt}$={alpha_opt} estimate (thin purple dashed line, where the proportion of unclassified states reaches {fraction_unclassified_for_alpha_opt}\% of its maximal value) obtained with the above procedure.

*** FIGURE: The NSI measure across multiple recordings: variability and estimated accuracy. Showing 8 cells covering the whole range of observed correlations between $V_m$ and the pLFP signal.
#+options : {'label':'All', 'extent': 'doublecolumn'}
(a) A 30s sample of the simultaneous $V_{ext}$ (gray trace) and $V_m$ (black trace) signals. At the bottom, we show the validated network states with their NSI value. (b) Scatter plots of the "$V_m$-defined NSI" and the "pLFP-defined NSI" values for all validated episode in a given cell (i.e., extending before and after the recording sample shown in *a*). We highlight the correct area with a green color and the uncorrect area with a red color. The red cross gives an example of the different sort of rejections that may happen given the matching criteria (see main text). (c) Histogram of the NSI over the whole recording for each cell. The color code per cell (from red to blue) represents the value of the correlation coefficient between the $V_m$ and pLFP signals.
[[./Figures/Fig_All_cells.png]]

*** An estimate of the NSI accuracy

We have determined all parameters required for the NSI analysis (summarized in Table {params}) and we now look for an estimate of the accuracy of such characterization. The initial motivation behind this classification was based on a qualitative correspondence between the pLFP and $V_m$ fluctuations. To obtain a cross-validation of our method, we now quantify this similarity across all our recordings.

To perform such a comparison, we now apply the NSI method on the $V_m$ signal. The exact same procedure can indeed be applied by replacing the pLFP signal by the membrane potential $V_m$. The lower bound of the signal $p_0$ is translated into the $V_{m0}$ value by also taking the first 100th percentile of the $V_m$ distribution (see Figure {pLFP}a and Figure {All}a). We compute the sliding mean and the time-varying low frequency power with the same parameters as for the pLFP signal. From this we can derived the $X(t)$ and $Y(t)$ quantities and therefore the "$V_m$-defined NSI" ($NSI_{V_m}$) signal according to Equation {NSI}. We now compare the value of the "$V_m$-defined NSI" signal during the validated network states of the "pLFP-defined NSI" signal. 

We implement a strict criteria to compare the two values. This procedure is depicted in Figure {All}c. We first determine the scaling rule $F$ between the "$V_m$-defined NSI" signal ($\textrm{NSI}_{V_m}$) and the "pLFP-defined NSI" signal (($\textrm{NSI}_{\textrm{pLFP}}$)) by performing a linear fit of the data predicting either both rythmicity or both non-rhythmicity (i.e. on the lower left or the upper right of the plots in Figure {All}c). Then a given time-point $t_i$ is associated to a correct network state identification if the difference between the point lies within the noise level of the pLFP signal (here taken, as before, as the baseline level of pLFP signal $p_0$), i.e. if $ \| F\big( \textrm{NSI}_{V_m}(t_i) \big) - \textrm{NSI}_{\textrm{pLFP}}(t_i) \| < p_0$. The strictness of this criteria can be seen in Figure {All}c. Not only the states are taken as incorrect when there is a mismatch between the rhythmic vs non-rhythmic conditions (what happens in cells 2,4,6,7,8) but also when the granularity of the rhythmicity or the non-rhythmicity is not matched (what happens in cells 1,3,5), e.g. in cell 1, the $\textrm{NSI}_{V_m}$ value does not display a high enough value to be linearly related to $\textrm{NSI}_{pLFP}$ level according to the relationship $F$).

The final accuracy was found to be {matching_percentage_NSI_pLFP_Vm}\% over the n={Ncells} cells and all validated episodes. 

Lowering the tolerance to $p^{tol}$={p_noise_for_accuracy_strict}$\mu$V and $V_m^{tol}$={Vm_noise_for_accuracy_strict}mV led to an accuracy of {matching_percentage_NSI_pLFP_Vm_strict}\%, meaning that in more than half of the cases the network state could be identified with a remarkable precision. It should also be noted that this accuracy value holds under the hypothesis that the $V_m$ classification would perfectly predict network states. Because a single pyramidal neuron samples only a finite amount of synapses, the relationship between its depolarization level and the endogenous local activity should be noisy. This estimate should therefore be interpreted as a lower bound of the method's accuracy. 

The misclassification was however not homogeneous among the different rejection cases. One specific case, namely predicting non-rhythmic activity from the pLFP ($\textrm{NSI}_{pLFP}$>0) while predicting rhythmic activity from the $V_m$ signal ($\textrm{NSI}_{Vm}$<0), represented {misclassification_pLFP_NR_Vm_R}\% of the misclassifications over the merged episodes across all cells (i.e. {misclassification_pLFP_NR_Vm_R_total}\% of all episodes). We analyze in the next section the origin of this phenomena.

*** Graded aspect of network states in terms of pLFP and $V_m$ fluctuations: rhythmic versus non-rhythmic states: 

From the previous analysis, we find a stronger tendency to classify network states as rhythmic from the $V_m$ than from the pLFP fluctuations. Such a specific bias suggests that the fluctuations in terms of pLFP and $V_m$ signal are not exactly symmetric with respect to the NSI measure. We therefore analyzed more closely the correlate in terms of $V_m$ fluctuations of the different levels of NSI. 

For non-rhythmic activity (NSI>0), the level of the network state index is given by the mean pLFP in the time window $T_{state}$={Tstate}ms, we compare this quantity to the mean membrane potential depolarization level in the same window $T_{state}$ (the depolarization is estimated as the deflection from a minimum polarization level, estimated as the mean $V_m$ level when pLFP<$p_0$). For rhythmic activity (NSI<0), the level of the network state index is given by the value of the maximum power of the pLFP signal in the [2,10]Hz band, we compare this quantity to the same power in the $V_m$ signal. We show the relationship between those pLFP-defined and $V_m$-defined levels for two cells in Figure {Granul}a,b (for Cell 1 and Cell 3 respectively) and on Figure {Granul}c we show the population data for those relationships.

We found that the depolarization level exhibits a strong dependency on the NSI level for rhythmic activity (NSI>0), see Figure {Granul}. We show single episodes of increasing NSI levels (numbered 3,4,5,6 in Figure {Granul}a,b) and their respective episode averages at all NSI>0 levels for those two cells (kaki curves in Figure {Granul}a,b). The $\sim$15$\mu$V variability in terms of NSI levels is translated into a $\sim$30mV variability of depolarization level with a clear monotonic relationship for those two sample cells. This behavior was confirmed at the population level (Figure {Granul}c). We standardized the analysis across all cells by binning the NSI levels from 0$\mu$V to {NSI_Max_for_granularity_analysis}$\mu$V (a range covering all observed values) in bins of {NSI_bin_for_granularity_analysis}$\mu$V and, for each cell, we consider only the NSI levels including more than {NEpisode_MIN_for_granularity_analysis} episodes to get a meaningful average. We found that all cells exhibited depolarizations with a steep dependency on the NSI level {value_of_slopes_for_nonrhythmic_granularity_analysis}mV$/ \mu$V, significantly deviating from the null hypothesis of a zero slope (p={pvalue_slopes_for_nonrhythmic_granularity_analysis}, n={n_slopes_for_nonrhythmic_granularity_analysis} cells, paired t-test).

On the other hand, we found that the level of NSI for rhythmic activity (NSI<0) had a much lower impact on the depolarization level, see Figure {Granul}. The $\sim$10$\mu$V variability in terms of NSI levels is now translated into a weakly modulated $V_m$ oscillation with a 5-10mV amplitude (purple curves in Figure {Granul}a,b). We highlight this weak dependency on the selected samples shown in Figure {Granul}a,b. From episode (2) to episode (1), the amplitude of the envelope of the pLFP oscillation increases (decreasing NSI) while the $V_m$ amplitude can either increase (Figure {Granul}a) or decrease (Figure {Granul}b). Now binning the NSI levels from -{NSI_Max_for_granularity_analysis}$\mu$V to 0$\mu$V, we performed this analysis on all cells. At the population level, we also found that the mean depolarization had a weak dependency on the NSI level {value_of_slopes_for_rhythmic_granularity_analysis}mV$/ \mu$V which was not significantly deviating from the null hypothesis of a zero slope (p={pvalue_slopes_for_rhythmic_granularity_analysis}, over the n={n_slopes_for_rhythmic_granularity_analysis} cells displaying rhythmic activity within multiple NSI bins, paired t-test). It should be noted that the lack of graded $V_m$ response for rhythmic activity was not related to the thresholding that reduced the NSI range of (NSI<0) intervals. When raising $\alpha$ up to 5 (where the range of NSI<0 values is greatly increased, because low pLFP episodes are now classified as rhythmic, see Figure {Granul}e), the depolarization level still shows a very weak dependency to the NSI level compared to the dependency observed for non-rhythmic activity (Figure {Granul}c, top) with similar statistical significance values (see Figure {Granul}c, bottom). 

We conclude that the granularity captured by the NSI has a strong correlate in terms of membrane potential polarization for non-rhythmic activity (NSI>0) while the various NSI levels of rhythmic activity (NSI<0) rather correspond to a stereotypical $V_m$ oscillation with $\sim$5-10mV amplitude.

This finding therefore explains the observed bias in our cross-validation analysis. The stereotypical (weakly gradual) [2,10]Hz $V_m$ patterns are easily classified as rhythmic even when the pLFP patterns have a weak [2,10]Hz amplitude (the misclassification cases indeed originate from episodes of low [2,10]Hz power in the pLFP signal, the mean power in misclassified cases is significantly lower than in cross-validated cases, {pLFP_low_freq_pow_for_wrong_nonrhythmic}$\mu$V versus {pLFP_low_freq_pow_for_true_rhythmic}$\mu$V, p={pvalue_low_freq_pow_for_wrong_nonrhythmic} paired t-test, in the n={n_low_freq_pow_for_wrong_nonrhythmic} cells displaying both conditions). The opposite situation, predicting non-rhythmic activity from the $V_m$ signal ($\textrm{NSI}_{Vm}$>0) represented a much weaker fraction {misclassification_pLFP_R_Vm_NR}\% of the misclassifications (i.e. {misclassification_pLFP_R_Vm_NR_total}\% of all episodes) and can likely be attributed to \textit{private} fluctuations in the $V_m$ signal. Finally, the strong relationship between the pLFP and $V_m$ signals during non-rhythmic states (Figure {Granul}a-c, kaki curves) insured a reliable prediction of the network states by representing only {misclassification_pLFP_NR_Vm_NR}\% of the misclassifications (i.e. {misclassification_pLFP_NR_Vm_NR_total}\%  of all episodes).

*** FIGURE: Link between the NSI levels and the properties of the $V_m$ fluctuations.
#+options : {'label':'Granul', 'sidecap':(0.4, 0.04, 0.5)}
(a) Relationship, at the single cell level (Cell 1), between the NSI level across validated episodes and the $V_m$ amplitude of the [2,10]Hz power for rhythmic states (NSI<0 states) and of the mean $V_m$ depolarization level over the $T_{state}$={Tstate}ms window for the non-rhythmic States (NSI>0 states). We bin the NSI levels and compute the mean (plain curve) and standard deviation (shaded area) for all episodes falling within this bin. The purple and kaki colors represent the rhythmic and non-rhythmic states respectively. We highlight with grey dots the values of the single episodes visible on Figure {NSI}a (reproduced on the top inset, $V_m$ in black and pLFP in brown). We estimate the dependency of the $V_m$ fluctuations with a linear regression with respect to the NSI level (red dashed curve). (b) Same than *a* for Cell 3. Note that the plain curve does not reach episode 3 because the minimum number of episodes is not reached at that level (see main text). (c) Reproducing the analysis of *a* over all n={Ncells} cells (see main text). We now consider only the mean relations over cells (thin gray lines). We show the mean (wide curve) and the standard deviation (shaded area) across cells (N.B. evaluated only for the NSI levels displayed by multiple cells, i.e. n={n_slopes_for_rhythmic_granularity_analysis} cells for rhythmic activity and n={n_slopes_for_nonrhythmic_granularity_analysis} cells for non-rhythmic activity). For each cell, we perform a linear regression with respect to the NSI levels, we compute the mean across cells $\langle s \rangle$ and the probability of a deviation from the 0-slope hypothesis $p$ (paired t-test). (d) Link between $\alpha$ parameter (that sets the proportion of non-rhythmic episodes, see Figure {NSI}c) and the mean slope over cells (top, $\langle s \rangle_{cells}$) as well as p-value for a significant non-zero slope (bottom). The slope value weakly depends on the $\alpha$ parameter, meaning that the weak dependency on the NSI level during rhythmic episodes can not be attributed to a too low sampling of rhythmic states under the setting $\alpha=\alpha^{opt}$=2.8 used in *a*,*b* and *c*. (e) 
[[./Figures/Fig_Granularity.png]]

*** FIGURE: Features in the distribution of the NSI measure explain the diversity of the correlation value over recordings between the population and single cell signals (the pLFP and $V_m$ signals respectively).
#+options : {'label':'Correl', 'extent':'singlecolumn'}
(a) We perform a linear-regression between cc($V_m$-pLFP) and the following statistical quantities characterizing the NSI distribution: 1) the variability $\sigma_{NSI}$ (standard deviation) of the NSI values across the whole recording, 2) the variability in NSI values restricted to non-rhythmic episodes $\sigma_{NSI>0}$, 3) the fraction of non-rhythmic episodes $F_{NSI<0}$, 4) the mean NSI over the whole recording, 5) the variability in NSI values restricted to rhythmic episodes $\sigma_{NSI<0}$, 6) the mean in NSI values restricted to non-rhythmic episodes $\sigma_{NSI>0}$, 7) the mean in NSI values restricted to rhythmic episodes $\sigma_{NSI<0}$. We show the explained variance for all quantities on the x-axis and p-value of this linear dependency. We also performed a multiple linear regression over those different components (bottom gray bar). The increased value of the multiple regression model (80\% of explained variance, adjusted $R^2$) shows that the combination of statistical features in the NSI distribution largely explain the observed variability across cells. (b) Scatter plot between the four most significant components of the NSI distribution (see variance explained and p-values in *a*) and the cc($V_m$, pLFP) across individual recordings. The color code of individual cells matches that of Figure {All}.
[[./Figures/Fig_Explained_Correl.png]]

*** Network state distributions captured by the NSI in the somato-sensory cortex of awake head-fixed mice

We now analyze the output of this method on the whole dataset of the present study, the n={Ncells} simultaneous $V_m$ and $V_{ext}$ recordings in the somato-sensory cortex of head-fixed awake mice. We show on Figure {All} height example recordings representative of the dataset, i.e. spanning the full range of correlations between the pLFP and $V_m$ fluctuations (see Figure {pLFP}c). We show a 30s sample of the intra- and extracellular recordings together with the time-varying NSI on Figure {All}a and the histogram of the NSI levels across the whole recording in Figure {All}b.

Overall, the dataset was dominated by non-rhythmic activity with $F_{NSI>0}$={occurence_of_nonrhythmic}\%. The fraction of rhythmic activity exhibited a large variability with n={n_fraction_below_2} recordings below $F_{NSI<0}$=2\% and n={n_fraction_above_35} recordings above $F_{NSI<0}$=35\% (peaking at $F_{NSI<0}$={max_occurence_of_rhythmic}\% for Cell 3, see Figure {All}b).

The mean absolute NSI values were $\langle \| \textnormal{NSI}_{NSI<0} \| \rangle $={mean_NSI_of_rhythmic}$\mu$V over rhythmic periods and $\langle \| \textnormal{NSI}_{NSI>0} \| \rangle $={mean_NSI_of_nonrhythmic}$\mu$V for non-rhythmic periods, yielding a significant increase from rhythmic to non-rhythmic (p={pvalue_mean_NSI}, paired t-test). The increased amplitude in terms of pLFP signal (i.e. high frequency content of the LFP) suggests that, as an average, the synaptic activity is stronger in the non-rhythmic periods that in the rhythmic ones. This increased range of pLFP level was also true for the maximum level displayed by single recordings with {max_NSI_of_rhythmic}$\mu$V versus {max_NSI_of_nonrhythmic}$\mu$V (p={pvalue_max_NSI}, paired t-test) for rhythmic and non-rhythmic activity respectively. During non-rhythmic periods we also found a weakly significant increase of the variability (from {std_NSI_of_rhythmic}$\mu$V to {std_NSI_of_nonrhythmic}$\mu$V, p={pvalue_std_NSI}, paired t-test) and skewness of the pLFP values (from {skew_NSI_of_rhythmic}$\mu$V to {skew_NSI_of_nonrhythmic}$\mu$V, p={pvalue_skew_NSI}, paired t-test).

*** Network state variability within a single recording shape the average correlations values between population and single cell signals

We now use the above quantification to analyze one of the striking property of this dataset: the strong variability from recording to recording (see Figure {pLFP}c and Figure {All}b) of the correlation cc($V_m$, pLFP) between the time-varying population signal pLFP$(t)$ and the single cell signal $V_m(t)$. 

From top to bottom, one can see on Figure {All}c, that the distribution of NSI gets narrower .

{pvalue_$\sigma_{NSI}$}
{rsquared_$\sigma_{NSI}$}\% of the variability
% ', '$\sigma_{NSI>0}$', '$F_{NSI<0}$', '$\mu_{NSI}$', '$\sigma_{NSI<0}$', '$\mu_{NSI>0}$', '$\mu_{NSI<0}$']

We first look at the relationship between the average NSI over the recording and the cc-$V_m$-pLFP value (Figure 4a). We find a 0.5 correlation with a relationship close to statistical significance (p=0.1). Similarly, the occurence of rhythmic activity (NSI<0) display a similar correlation coefficient with an increased statistical confidence value (p=0.04). However, the relationship between the variability of the NSI over the whole recording (s.e.m of the NSI values) and the cc-$V_m$-LFP displays an higher correlation coefficient (c=0.71) and a clear statistical relationship (p=0.005).

Importantly, this increased statistical dependency demonstrates that not only the occurence of the rhythmic activity explains the correlation between the $V_m$ and the pLFP, but more generally the variability in network states (i.e. also the variability in non-rhythmic states). Cell 2 in Figure {All} provides an example of such a phenomena, it exhibits a strong variability in terms of non-rhythmic states and a relatively low occurence of rhythmic activity (e.g. lower than Cell 6), and still, display a high correlation coefficient (cc-$V_m$-pLFP=0.66).

{rsquared_full_regression_model}\%
p={pvalue_full_regression_model}


* Discussion

We provide a measure for network states during wakefulness.

We further analyze the neurophysiological correlate of the higher order quantity given by the network state index: the graded levels of the NSI measure on both its positive and negative axis. To this purpose, we will now analyze the correlate in terms of $V_m$ fluctuations of the different levels of NSI. 

Despite those limitations, this relatively high matching value suggests that the NSI is a valid index to characterize the various network states found during wakefulness from extracellular recordings.

The question whether the lack of $V_m$ correlate in rhythmic states is an artefact of our method remains open.
It could also be that the [2,10]Hz involves a weak implication of the local sensory network ().

Flexible -> can be adjusted to a specific question.
The $\alpha$ parameter can therefore be adjusted with respect to the specific context in which the NSI is used. If an investigation focuses on slow rhythmic activity, one should be rather conservative in its determination and a low $\alpha$ parameter should be preferred (e.g. $\alpha$=2). On the other hand if an investigation focuses on asynchronous dynamics (non-rhythmic states), a higher $\alpha$ would be a conservative value (e.g. $\alpha$>3).

If interpreting (Buzsaki Einevoll, review)

Extending to more neurophysiological patterns (anesthesia, etc...)

Discrepancy between LFP-predicted network states and $V_m$-defined network states

* References

[[Buzsáki et al., 2012]] Buzsáki, G., Anastassiou, C. A., & Koch, C. (2012). The origin of extracellular fields and currents—EEG, ECoG, LFP and spikes. Nature reviews neuroscience, 13(6), 407.

[[Einevoll et al., 2013]] Einevoll, G. T., Kayser, C., Logothetis, N. K., & Panzeri, S. (2013). Modelling and analysis of local field potentials for studying the function of cortical circuits. Nature Reviews Neuroscience, 14(11), 770.

[[McGinley et al., 2015a]] McGinley, M.J.J., David, S.V. V, and McCormick, D.A.A. (2015). Cortical Membrane Potential Signature of Optimal States for Sensory Signal Detection. Neuron 87, 179–192.

[[McGinley et al., 2015b]] McGinley, M.J., Vinck, M., Reimer, J., Batista-Brito, R., Zagha, E., Cadwell, C.R., Tolias, A.S., Cardin, J.A., and McCormick, D.A. (2015). Waking State: Rapid Variations Modulate Neural and Behavioral Responses. Neuron 87, 1143–1161.

[[Mukovski et al., 2006]] Mukovski, M., Chauvette, S., Timofeev, I., \& Volgushev, M. (2006). Detection of active and silent states in neocortical neurons from the field potential signal during slow-wave sleep. Cerebral Cortex, 17(2), 400-414.

[[Oliphant, 2007]] Oliphant, T.E. (2007). SciPy: Open source scientific tools for Python. Comput. Sci. Eng. 9, 10–20.

[[Pérez and Granger, 2007]] Pérez, F., and Granger, B.E. (2007). {IP}ython: a {S}ystem for {I}nteractive {S}cientific {C}omputing. {C}omput. {S}ci. {E}ng. 9, 21–29.

[[Polack et al., 2013]] Polack, P.-O., Friedman, J., and Golshani, P. (2013). Cellular mechanisms of brain state–dependent gain modulation in visual cortex. Nat. Neurosci. 16, 1331–1339.

[[Poulet and Petersen, 2008]] Poulet, J. F., \& Petersen, C. C. (2008). Internal brain state regulates membrane potential synchrony in barrel cortex of behaving mice. Nature, 454(7206), 881.

[[Reimer et al., 2014]] Reimer, J., Froudarakis, E., Cadwell, C.R., Yatsenko, D., Denfield, G.H., and Tolias, A.S. (2014). Pupil fluctuations track fast switching of cortical states during quiet wakefulness. Neuron 84, 355–362.

[[Zucca et al., 2017]] Zucca, S., D’Urso, G., Pasquale, V., Vecchia, D., Pica, G., Bovetti, S., Moretti, C., Varani, S., Molano-Mazón, M., Chiappalone, M., et al. (2017). An inhibitory gate for state transition in cortex. Elife 6.

# end bibiography

* Notes :noexport:

# to be filled   
\begin{table}[tb!]
\small
\centering
\begin{tabular}{c|c|c|c}
~ & \multicolumn{1}{c|}{ \bf Parameter} & {\hfill \bf Symbol \hfill} & \multicolumn{1}{c}{ \bf Value} \\
\hline
\multirow{4}{*}{\rotatebox[origin=c]{90}{\parbox[c]{1cm}{\centering \bf fixed }}} 
                     & \multirow{2}{*}{ \centering pLFP root freq.} 
                     & \multirow{2}{*}{ \centering $f_0$ } 
                     & \multirow{2}{*}{ \centering {f0} Hz} \\[-0.1cm]
&&& \\[-0.1cm]
& \multirow{2}{*}{\parbox[c]{3.5cm}{\centering pLFP band factor}} 
                     & \multirow{2}{*}{$w_0$} 
                     & \multirow{2}{*}{ {w0} } \\[0.1cm]
&&& \\[-0.1cm]
& \multirow{2}{*}{\parbox[c]{3.5cm}{\centering factor for rhythmicity threshold}} 
                     & \multirow{2}{*}{$\alpha$} 
                     & \multirow{2}{*}{ {alpha_opt} } \\[-0.1cm]
&&& \\
\hline
\multirow{4}{*}{\rotatebox[origin=c]{90}{\parbox[c]{1cm}{\centering \bf data-driven }}} & text &&\\
& \multirow{2}{*}{\parbox[c]{3.5cm}{pLFP lower bound}} & \multirow{2}{*}{$p_0} & \multirow{2}{*}{ {p0_over_cells}$\mu$V } \\
\end{tabular}
\label{table:params}
\caption{ \textbf{Parameters of the NSI characterization.}
We summarize here all analysis parameters. We separate the parameters into two classes: the fixed parameters that are constant across different recordings (although there value has been experimentally determined from the average data, see Figure {pLFP} and Figure {NSI}) and the data-driven parameters that are evaluated on single recordings.}
\normalfont
\end{table}

* Supplementary Material
*** FIGURE: Wavelet transform with its custom normalization
#+options : {'label':'Morlet', 'extent':'singlecolumn'}
(a) The Morlet wavelet at different frequencies (real and imaginary parts as plain and dashed lines respectively). (b) Time-frequency analysis based on the wavelet transform. Note that the chosen normalization (normalizing with respect to a sinusoid rather than the wavelet itself) insures that the amplitude of a modulated signals is kept in the amplitude of the wavelet transform.
[[./Figures/Fig_Wavelet_Demo.png]]

*** Normalization of the Wavelet Transform

*** FIGURE: Dependency on the $\alpha$ parameter for the link between the granularity of the pLFP-defined networks states and the granularity of the $V_m$ fluctuations
#+options : {'label':'SuppGranul', 'width':0.99}
From left to right, we increase the $\alpha$ parameter: (a) $\alpha$=1 (b) $\alpha$=2.3 (c) $\alpha$=3.7 (d) $\alpha$=5. Note that despite an increase in the NSI range of observed low-frequency activity (when we raise $\alpha$, more low pLFP amplitude events are classified as rhythmic, thus extending the NSI range of variations toward low values) the relationship to the depolarization level is poorly affected. On the other hand, at all $\alpha$, the non-rhythmic events have a depolarization level exhibiting a steep dependency to the NSI level.
[[./Figures/Fig_Supp_Granularity.png]]

*** FIGURE: Same as in Figure {All} for the remaining n=6 cells. 
#+options : {'label':'supp-All', 'extent': 'doublecolumn'}
See legend in Figure {All}.
[[./Figures/Fig_All_cells_supp.png]]

